<main class="backgroundView">
  <div class="header-section mb-4" style="margin-left: 20px">
    <h2 class="fw-bold">Record Produce Sold on Credit</h2>
    <p class="text-muted">
      Fill in the details below to log a credit/deferred payment sale for trusted buyers.
    </p>
  </div>

  <div class="formDesign w-100">
    <form id="creditSalesForm">
      
      <section class="mb-4">
        <h5 class="border-bottom pb-2 fw-semibold"><i class="bi bi-person-vcard me-2"></i>Buyer Details</h5>
        <div class="Details d-flex flex-wrap gap-3">
          <label for="buyerName">
            <p class="mb-1 small fw-bold">Buyer Name</p>
            <input
              id="buyerName"
              name="buyerName"
              type="text"
              class="form-control"
              pattern="[A-Za-z0-9 ]{2,}"
              required
              placeholder="e.g., Odongo Enterprises"
            />
          </label>

          <label for="nationalId">
            <p class="mb-1 small fw-bold">National ID (NIN)</p>
            <input
              id="nationalId"
              name="nationalId"
              type="text"
              class="form-control text-uppercase"
              pattern="[A-Z0-9]{14}"
              title="NIN must be exactly 14 characters"
              required
              placeholder="e.g., CM8503210TRK4L"
            />
          </label>

          <label for="location">
            <p class="mb-1 small fw-bold">Location</p>
            <input
              id="location"
              name="location"
              type="text"
              class="form-control"
              pattern="[A-Za-z0-9 ]{2,}"
              required
              placeholder="e.g., Bweyale"
            />
          </label>

          <label for="buyerContact">
            <p class="mb-1 small fw-bold">Buyer Contact</p>
            <input
              id="buyerContact"
              name="buyerContact"
              type="tel"
              class="form-control"
              pattern="^0[0-9]{9}$"
              required
              placeholder="e.g., 0771234567"
            />
          </label>
        </div>
      </section>

      <section class="mb-4">
        <h5 class="border-bottom pb-2 fw-semibold"><i class="bi bi-cash-stack me-2"></i>Transaction Details</h5>
        <div class="Details d-flex flex-wrap gap-3">
          <label for="amountDue">
            <p class="mb-1 small fw-bold">Amount Due (UgX)</p>
            <input
              id="amountDue"
              name="amountDue"
              type="number"
              class="form-control"
              min="10000"
              required
              placeholder="e.g., 1500000"
            />
          </label>

          <label for="agentName">
            <p class="mb-1 small fw-bold">Sales Agent Name</p>
            <input
              id="agentName"
              name="agentName"
              type="text"
              class="form-control bg-light"
              readonly
              required
            />
          </label>

          <label for="dueDate">
            <p class="mb-1 small fw-bold">Due Date</p>
            <input id="dueDate" name="dueDate" type="date" class="form-control" required />
          </label>
        </div>
      </section>

      <section class="mb-4">
        <h5 class="border-bottom pb-2 fw-semibold"><i class="bi bi-box-seam me-2"></i>Produce Details</h5>
        <div class="Details d-flex flex-wrap gap-3">
          <label for="produceName">
            <p class="mb-1 small fw-bold">Produce Name</p>
            <select id="produceName" name="produceName" class="form-select" required style="min-width: 200px;">
              <option value="">Select Produce</option>
              <option value="Beans">Beans</option>
              <option value="Grain Maize">Grain Maize</option>
              <option value="Cow Peas">Cow Peas</option>
              <option value="G-nuts">G-nuts</option>
              <option value="Soybeans">Soybeans</option>
            </select>
          </label>

          <label for="produceType">
            <p class="mb-1 small fw-bold">Produce Type</p>
            <input
              id="produceType"
              name="produceType"
              type="text"
              class="form-control"
              pattern="[A-Za-z]{2,}"
              required
              placeholder="e.g., Grains"
            />
          </label>

          <label for="tonnage">
            <p class="mb-1 small fw-bold">Tonnage (kgs)</p>
            <input
              id="tonnage"
              name="tonnage"
              type="number"
              class="form-control"
              min="1"
              required
              placeholder="e.g., 1000"
            />
          </label>

          <label for="dispatchDate">
            <p class="mb-1 small fw-bold">Dispatch Date</p>
            <input id="dispatchDate" name="dispatchDate" type="date" class="form-control" required />
          </label>
        </div>
      </section>

      <div class="formActions d-flex justify-content-end gap-2 mt-4 pb-5">
        <button type="reset" class="btn btn-outline-secondary px-4">Clear Form</button>
        <button type="submit" class="btn btn-success px-5 fw-bold" style="background-color: green; border-color: green;">
          Save Credit Sale
        </button>
      </div>
    </form>
  </div>
</main>

<script>
  /**
   * Initialization Logic for Credit Sales Page
   */
  (function initCreditSales() {
    // 1. Auto-fill Sales Agent Name from Session
    const _userDetails = localStorage.getItem('userDetails');
    if (_userDetails) {
      const user = JSON.parse(_userDetails);
      const agentInput = document.getElementById('agentName');
      if (agentInput) {
        agentInput.value = `${user.firstName} ${user.lastName || user.lastname}`;
      }
    }

    // 2. Set Default Dispatch Date to Today
    const dispatchDateInput = document.getElementById('dispatchDate');
    if (dispatchDateInput) {
      dispatchDateInput.value = new Date().toISOString().split('T')[0];
    }
  })();

  /**
   * Form Submission Handling
   */
  document.getElementById('creditSalesForm').onsubmit = function(event) {
    event.preventDefault();
    
    // Validation: Double check NIN length
    const nin = document.getElementById('nationalId').value;
    if(nin.length !== 14) {
        alert("Critical Error: National ID must be exactly 14 characters.");
        return;
    }

    console.log("Credit Sale Data Ready for Backend:", new FormData(this));
    alert("Credit sale record successfully validated and saved!");
  };
</script>